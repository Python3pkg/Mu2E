

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>mu2e.fieldfitter &mdash; Mu2E 1.0.0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
  

  
    <link rel="top" title="Mu2E 1.0.0 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Mu2E
          

          
          </a>

          
            
            
              <div class="version">
                1.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">Mu2E Experiment Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../field_view.html">The Mu2E Magnetic Fields</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../formula.html">Mathematical Formalism</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dataframeprod.html">Prepping Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fitting.html">Fitting Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plotting.html">Plotting</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">Mu2E</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
    <li>mu2e.fieldfitter</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for mu2e.fieldfitter</h1><div class="highlight"><pre>
<span class="c">#! /usr/bin/env python</span>
<span class="sd">&quot;&quot;&quot;Module for fitting magnetic field data with a parametric expression.</span>

<span class="sd">This is the main workhorse module for fitting the magnetic field data.  It is assumed that the data</span>
<span class="sd">has passed through the :class:`mu2e.dataframeprod.DataFrameMaker`, and thus in the expected format.</span>
<span class="sd">In most cases the data has also passed through the :mod:`mu2e.hallprober` module, to imitate the act</span>
<span class="sd">of surveying one of the Mu2E solenoids with a series of hall probes.  The</span>
<span class="sd">:class:`mu2e.fieldfitter.FieldFitter` preps the data, flattens it into 1D, and uses the :mod:`lmfit`</span>
<span class="sd">package extensively for parameter-handling, fitting, optimization, etc.</span>

<span class="sd">Example:</span>
<span class="sd">    Coming soon...</span>

<span class="sd">*2016 Brian Pollack, Northwestern University*</span>

<span class="sd">brianleepollack@gmail.com</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">cPickle</span> <span class="k">as</span> <span class="nn">pkl</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">lmfit</span> <span class="k">import</span> <span class="n">Model</span><span class="p">,</span> <span class="n">Parameters</span><span class="p">,</span> <span class="n">report_fit</span>
<span class="kn">from</span> <span class="nn">mu2e</span> <span class="k">import</span> <span class="n">mu2e_ext_path</span>
<span class="kn">import</span> <span class="nn">tools.fit_funcs</span> <span class="k">as</span> <span class="nn">ff</span>


<div class="viewcode-block" id="FieldFitter"><a class="viewcode-back" href="../../fitting.html#mu2e.fieldfitter.FieldFitter">[docs]</a><span class="k">class</span> <span class="nc">FieldFitter</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Input field measurements, perform parametric fit, return relevant quantities.</span>

<span class="sd">    The :class:`mu2e.fieldfitter.FieldFitter` takes a 3D set of field measurements and their</span>
<span class="sd">    associated position values, and performs a parametric fit.  The parameters and fit model are</span>
<span class="sd">    handled by the :mod:`lmfit` package, which in turn wraps the :mod:`scipy.optimize` module, which</span>
<span class="sd">    actually performs the parameter optimization.  The default optimizer is the Levenberg-Marquardt</span>
<span class="sd">    algorithm.</span>

<span class="sd">    The :func:`mu2e.fieldfitter.FieldFitter.fit` requires multiple cfg `namedtuples`, and performs</span>
<span class="sd">    the actual fitting (or recreates a fit for a given set of saved parameters).  After fitting, the</span>
<span class="sd">    generated class members can be used for further analysis.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_data (pandas.DataFrame): DF that contains the field component values to be fit.</span>
<span class="sd">        cfg_geom (namedtuple): namedtuple with the following members:</span>
<span class="sd">            &#39;geom z_steps r_steps phi_steps xy_steps bad_calibration&#39;</span>

<span class="sd">    Attributes:</span>
<span class="sd">        input_data (pandas.DataFrame): The input DF, with possible modifications.</span>
<span class="sd">        phi_steps (List[float]): The axial values of the field data (cylindrial coords)</span>
<span class="sd">        r_steps (List[float]): The radial values of the field data (cylindrial coords)</span>
<span class="sd">        xy_steps (List[float]): The xy values of the field data (cartesian coords)</span>
<span class="sd">        pickle_path (str): Location to read/write the pickled fit parameter values</span>
<span class="sd">        params (lmfit.Parameters): Set of Parameters, inherited from `lmfit`</span>
<span class="sd">        result (lmfit.ModelResult): Container for resulting fit information, inherited from `lmfit`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">cfg_geom</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span> <span class="o">=</span> <span class="n">input_data</span>
        <span class="k">if</span> <span class="n">cfg_geom</span><span class="o">.</span><span class="n">geom</span> <span class="o">==</span> <span class="s">&#39;cyl&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phi_steps</span> <span class="o">=</span> <span class="n">cfg_geom</span><span class="o">.</span><span class="n">phi_steps</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r_steps</span> <span class="o">=</span> <span class="n">cfg_geom</span><span class="o">.</span><span class="n">r_steps</span>
        <span class="k">elif</span> <span class="n">cfg_geom</span><span class="o">.</span><span class="n">geom</span> <span class="o">==</span> <span class="s">&#39;cart&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xy_steps</span> <span class="o">=</span> <span class="n">cfg_geom</span><span class="o">.</span><span class="n">xy_steps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pickle_path</span> <span class="o">=</span> <span class="n">mu2e_ext_path</span><span class="o">+</span><span class="s">&#39;fit_params/&#39;</span>

<div class="viewcode-block" id="FieldFitter.fit"><a class="viewcode-back" href="../../fitting.html#mu2e.fieldfitter.FieldFitter.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">cfg_params</span><span class="p">,</span> <span class="n">cfg_pickle</span><span class="p">,</span> <span class="n">profile</span><span class="o">=</span><span class="k">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper function that chooses one of the subsequent fitting functions.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">profile</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_solenoid</span><span class="p">(</span><span class="n">cfg_params</span><span class="p">,</span> <span class="n">cfg_pickle</span><span class="p">,</span> <span class="n">profile</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">geom</span> <span class="o">==</span> <span class="s">&#39;cyl&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fit_solenoid</span><span class="p">(</span><span class="n">cfg_params</span><span class="p">,</span> <span class="n">cfg_pickle</span><span class="p">,</span> <span class="n">profile</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">geom</span> <span class="o">==</span> <span class="s">&#39;cart&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fit_external</span><span class="p">(</span><span class="n">cfg_params</span><span class="p">,</span> <span class="n">cfg_pickle</span><span class="p">)</span></div>

<div class="viewcode-block" id="FieldFitter.fit_solenoid"><a class="viewcode-back" href="../../fitting.html#mu2e.fieldfitter.FieldFitter.fit_solenoid">[docs]</a>    <span class="k">def</span> <span class="nf">fit_solenoid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cfg_params</span><span class="p">,</span> <span class="n">cfg_pickle</span><span class="p">,</span> <span class="n">profile</span><span class="o">=</span><span class="k">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Main fitting function for FieldFitter class.</span>

<span class="sd">        The typical magnetic field geometry for the Mu2E experiment is determined by one or more</span>
<span class="sd">        solenoids, with some contaminating external fields.  The purpose of this function is to fit</span>
<span class="sd">        a set of sparse magnetic field data that would, in practice, be generated by a field</span>
<span class="sd">        measurement device.</span>

<span class="sd">        The following assumptions must hold for the input data:</span>
<span class="sd">           * The data is represented in a cylindrical coordiante system.</span>
<span class="sd">           * The data forms a series of planes, where all planes intersect at R=0.</span>
<span class="sd">           * All planes has the same R and Z values.</span>
<span class="sd">           * All positive Phi values have an associated negative phi value, which uniquely defines a</span>
<span class="sd">             single plane in R-Z space.</span>

<span class="sd">        Args:</span>
<span class="sd">           cfg_params (namedtuple): &#39;ns ms cns cms Reff func_version&#39;</span>
<span class="sd">           cfg_pickle (namedtuple): &#39;use_pickle save_pickle load_name save_name recreate&#39;</span>
<span class="sd">           profile (Optional[bool]): True if you want to exit after the model is built, before</span>
<span class="sd">               actual fitting is performed for profiling. Default is False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Nothing.  Generates class attributes after fitting, and saves parameter values, if</span>
<span class="sd">            saving is specified.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Reff</span>         <span class="o">=</span> <span class="n">cfg_params</span><span class="o">.</span><span class="n">Reff</span>
        <span class="n">ns</span>           <span class="o">=</span> <span class="n">cfg_params</span><span class="o">.</span><span class="n">ns</span>
        <span class="n">ms</span>           <span class="o">=</span> <span class="n">cfg_params</span><span class="o">.</span><span class="n">ms</span>
        <span class="n">func_version</span> <span class="o">=</span> <span class="n">cfg_params</span><span class="o">.</span><span class="n">func_version</span>
        <span class="n">Bz</span>           <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Br</span>           <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Bphi</span>         <span class="o">=</span> <span class="p">[]</span>
        <span class="n">RR</span>           <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ZZ</span>           <span class="o">=</span> <span class="p">[]</span>
        <span class="n">PP</span>           <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">phi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi_steps</span><span class="p">:</span>
            <span class="c"># determine phi and negative phi</span>
            <span class="k">if</span> <span class="n">phi</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">nphi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nphi</span> <span class="o">=</span> <span class="n">phi</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>

            <span class="c"># select data with correct pair of phis</span>
            <span class="n">input_data_phi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="p">[</span>
                <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">Phi</span><span class="p">,</span> <span class="n">phi</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">Phi</span><span class="p">,</span> <span class="n">nphi</span><span class="p">))</span>
            <span class="p">]</span>
            <span class="c"># make radial values negative for negative phis to prevent degeneracy</span>
            <span class="n">input_data_phi</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">input_data_phi</span><span class="o">.</span><span class="n">Phi</span><span class="p">,</span> <span class="n">nphi</span><span class="p">),</span> <span class="s">&#39;R&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>

            <span class="c"># convert B field components into 2D arrays</span>
            <span class="n">piv_bz</span> <span class="o">=</span> <span class="n">input_data_phi</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s">&#39;Z&#39;</span><span class="p">,</span> <span class="s">&#39;R&#39;</span><span class="p">,</span> <span class="s">&#39;Bz&#39;</span><span class="p">)</span>
            <span class="n">piv_br</span> <span class="o">=</span> <span class="n">input_data_phi</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s">&#39;Z&#39;</span><span class="p">,</span> <span class="s">&#39;R&#39;</span><span class="p">,</span> <span class="s">&#39;Br&#39;</span><span class="p">)</span>
            <span class="n">piv_bphi</span> <span class="o">=</span> <span class="n">input_data_phi</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s">&#39;Z&#39;</span><span class="p">,</span> <span class="s">&#39;R&#39;</span><span class="p">,</span> <span class="s">&#39;Bphi&#39;</span><span class="p">)</span>

            <span class="c"># bookkeeping for field and position values</span>
            <span class="n">R</span> <span class="o">=</span> <span class="n">piv_br</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span>
            <span class="n">Z</span> <span class="o">=</span> <span class="n">piv_br</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
            <span class="n">Bz</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">piv_bz</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">Br</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">piv_br</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">Bphi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">piv_bphi</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">RR_slice</span><span class="p">,</span> <span class="n">ZZ_slice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">Z</span><span class="p">)</span>
            <span class="n">RR</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RR_slice</span><span class="p">)</span>
            <span class="n">ZZ</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ZZ_slice</span><span class="p">)</span>
            <span class="n">use_phis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">input_data_phi</span><span class="o">.</span><span class="n">Phi</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
            <span class="c"># formatting for correct phi ordering</span>
            <span class="k">if</span> <span class="n">phi</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">use_phis</span> <span class="o">=</span> <span class="n">use_phis</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">PP_slice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">RR_slice</span><span class="p">,</span> <span class="n">use_phis</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">PP_slice</span><span class="p">[:,</span> <span class="nb">int</span><span class="p">(</span><span class="n">PP_slice</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">):]</span> <span class="o">=</span> <span class="n">use_phis</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">PP</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PP_slice</span><span class="p">)</span>

        <span class="c"># combine all phi slices</span>
        <span class="n">ZZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">ZZ</span><span class="p">)</span>
        <span class="n">RR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">RR</span><span class="p">)</span>
        <span class="n">PP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">PP</span><span class="p">)</span>
        <span class="n">Bz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">Bz</span><span class="p">)</span>
        <span class="n">Br</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">Br</span><span class="p">)</span>
        <span class="n">Bphi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">Bphi</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">profile</span><span class="p">:</span>
            <span class="c"># terminate here if we are profiling the code for further optimization</span>
            <span class="k">return</span> <span class="n">ZZ</span><span class="p">,</span> <span class="n">RR</span><span class="p">,</span> <span class="n">PP</span><span class="p">,</span> <span class="n">Bz</span><span class="p">,</span> <span class="n">Br</span><span class="p">,</span> <span class="n">Bphi</span>

        <span class="c"># Choose the type of fitting function we&#39;ll be using.</span>
        <span class="k">if</span> <span class="n">func_version</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">brzphi_3d_fast</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">brzphi_3d_producer_modbessel</span><span class="p">(</span><span class="n">ZZ</span><span class="p">,</span> <span class="n">RR</span><span class="p">,</span> <span class="n">PP</span><span class="p">,</span> <span class="n">Reff</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">ms</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">func_version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">brzphi_3d_fast</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">brzphi_3d_producer_bessel</span><span class="p">(</span><span class="n">ZZ</span><span class="p">,</span> <span class="n">RR</span><span class="p">,</span> <span class="n">PP</span><span class="p">,</span> <span class="n">Reff</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">ms</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">func_version</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">brzphi_3d_fast</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">brzphi_3d_producer_bessel_hybrid</span><span class="p">(</span><span class="n">ZZ</span><span class="p">,</span> <span class="n">RR</span><span class="p">,</span> <span class="n">PP</span><span class="p">,</span> <span class="n">Reff</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">ms</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">func_version</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">brzphi_3d_fast</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">brzphi_3d_producer_numba_v2</span><span class="p">(</span><span class="n">ZZ</span><span class="p">,</span> <span class="n">RR</span><span class="p">,</span> <span class="n">PP</span><span class="p">,</span> <span class="n">Reff</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">ms</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">func_version</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">brzphi_3d_fast</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">brzphi_3d_producer_modbessel_phase</span><span class="p">(</span><span class="n">ZZ</span><span class="p">,</span> <span class="n">RR</span><span class="p">,</span> <span class="n">PP</span><span class="p">,</span> <span class="n">Reff</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">ms</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s">&#39;func version &#39;</span><span class="o">+</span><span class="n">func_version</span><span class="o">+</span><span class="s">&#39; does not exist&#39;</span><span class="p">)</span>

        <span class="c"># Generate an lmfit Model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mod</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">brzphi_3d_fast</span><span class="p">,</span> <span class="n">independent_vars</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;r&#39;</span><span class="p">,</span> <span class="s">&#39;z&#39;</span><span class="p">,</span> <span class="s">&#39;phi&#39;</span><span class="p">])</span>

        <span class="c"># Load pre-defined starting valyes for parameters, or make a new set</span>
        <span class="k">if</span> <span class="n">cfg_pickle</span><span class="o">.</span><span class="n">use_pickle</span> <span class="ow">or</span> <span class="n">cfg_pickle</span><span class="o">.</span><span class="n">recreate</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">pkl</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pickle_path</span><span class="o">+</span><span class="n">cfg_pickle</span><span class="o">.</span><span class="n">load_name</span><span class="o">+</span><span class="s">&#39;_results.p&#39;</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">Parameters</span><span class="p">()</span>

        <span class="k">if</span> <span class="s">&#39;R&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;R&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">Reff</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="k">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&#39;ns&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;ns&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">ns</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="k">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;ns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">ns</span>
        <span class="k">if</span> <span class="s">&#39;ms&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;ms&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">ms</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="k">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;ms&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">ms</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ns</span><span class="p">):</span>
            <span class="c"># If function version 5, `D` parameter is a delta offset for phi</span>
            <span class="k">if</span> <span class="n">func_version</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">if</span> <span class="s">&#39;D_{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;D_{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mf">0.5</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;D_{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span><span class="o">.</span><span class="n">vary</span> <span class="o">=</span> <span class="k">True</span>
            <span class="c"># Otherwise `D` parameter is a scaling constant, along with a `C` parameter</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="s">&#39;C_{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;C_{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;C_{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span><span class="o">.</span><span class="n">vary</span> <span class="o">=</span> <span class="k">True</span>
                <span class="k">if</span> <span class="s">&#39;D_{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;D_{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">value</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;D_{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span><span class="o">.</span><span class="n">vary</span> <span class="o">=</span> <span class="k">True</span>

            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ms</span><span class="p">):</span>
                <span class="k">if</span> <span class="s">&#39;A_{0}_{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;A_{0}_{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">),</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;A_{0}_{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">)]</span><span class="o">.</span><span class="n">vary</span> <span class="o">=</span> <span class="k">True</span>
                <span class="k">if</span> <span class="s">&#39;B_{0}_{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;B_{0}_{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">),</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;B_{0}_{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">)]</span><span class="o">.</span><span class="n">vary</span> <span class="o">=</span> <span class="k">True</span>
                <span class="c"># Additional terms used in func version 3</span>
                <span class="k">if</span> <span class="n">func_version</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s">&#39;E_{0}_{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;E_{0}_{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">),</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;E_{0}_{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">)]</span><span class="o">.</span><span class="n">vary</span> <span class="o">=</span> <span class="k">True</span>
                    <span class="k">if</span> <span class="s">&#39;F_{0}_{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;F_{0}_{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">),</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;F_{0}_{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">)]</span><span class="o">.</span><span class="n">vary</span> <span class="o">=</span> <span class="k">True</span>
                    <span class="k">if</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;E_{0}_{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">)]</span><span class="o">.</span><span class="n">vary</span> <span class="o">=</span> <span class="k">False</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;F_{0}_{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">)]</span><span class="o">.</span><span class="n">vary</span> <span class="o">=</span> <span class="k">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">cfg_pickle</span><span class="o">.</span><span class="n">recreate</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s">&#39;fitting with n={0}, m={1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">ms</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s">&#39;recreating fit with n={0}, m={1}, pickle_file={2}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">ns</span><span class="p">,</span> <span class="n">ms</span><span class="p">,</span> <span class="n">cfg_pickle</span><span class="o">.</span><span class="n">load_name</span><span class="p">)</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cfg_pickle</span><span class="o">.</span><span class="n">recreate</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">vary</span> <span class="o">=</span> <span class="k">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mod</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">Br</span><span class="p">,</span> <span class="n">Bz</span><span class="p">,</span> <span class="n">Bphi</span><span class="p">])</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                                       <span class="n">r</span><span class="o">=</span><span class="n">RR</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">ZZ</span><span class="p">,</span> <span class="n">phi</span><span class="o">=</span><span class="n">PP</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
                                       <span class="n">method</span><span class="o">=</span><span class="s">&#39;leastsq&#39;</span><span class="p">,</span> <span class="n">fit_kws</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;maxfev&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="k">elif</span> <span class="n">cfg_pickle</span><span class="o">.</span><span class="n">use_pickle</span><span class="p">:</span>
            <span class="n">mag</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Br</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">Bz</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">Bphi</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mod</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">Br</span><span class="p">,</span> <span class="n">Bz</span><span class="p">,</span> <span class="n">Bphi</span><span class="p">])</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                                       <span class="n">weights</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">mag</span><span class="p">,</span> <span class="n">mag</span><span class="p">,</span> <span class="n">mag</span><span class="p">])</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                                       <span class="n">r</span><span class="o">=</span><span class="n">RR</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">ZZ</span><span class="p">,</span> <span class="n">phi</span><span class="o">=</span><span class="n">PP</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
                                       <span class="n">method</span><span class="o">=</span><span class="s">&#39;leastsq&#39;</span><span class="p">,</span> <span class="n">fit_kws</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;maxfev&#39;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mag</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Br</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">Bz</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">Bphi</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mod</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">Br</span><span class="p">,</span> <span class="n">Bz</span><span class="p">,</span> <span class="n">Bphi</span><span class="p">])</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                                       <span class="n">weights</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">mag</span><span class="p">,</span> <span class="n">mag</span><span class="p">,</span> <span class="n">mag</span><span class="p">])</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                                       <span class="n">r</span><span class="o">=</span><span class="n">RR</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">ZZ</span><span class="p">,</span> <span class="n">phi</span><span class="o">=</span><span class="n">PP</span><span class="p">,</span> <span class="n">cfg_params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
                                       <span class="n">method</span><span class="o">=</span><span class="s">&#39;leastsq&#39;</span><span class="p">,</span> <span class="n">fit_kws</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;maxfev&#39;</span><span class="p">:</span> <span class="mi">2000</span><span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">params</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s">&quot;Elapsed time was %g seconds&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>
        <span class="n">report_fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">,</span> <span class="n">show_correl</span><span class="o">=</span><span class="k">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cfg_pickle</span><span class="o">.</span><span class="n">save_pickle</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">cfg_pickle</span><span class="o">.</span><span class="n">recreate</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pickle_results</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pickle_path</span><span class="o">+</span><span class="n">cfg_pickle</span><span class="o">.</span><span class="n">save_name</span><span class="p">)</span></div>

<div class="viewcode-block" id="FieldFitter.fit_external"><a class="viewcode-back" href="../../fitting.html#mu2e.fieldfitter.FieldFitter.fit_external">[docs]</a>    <span class="k">def</span> <span class="nf">fit_external</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cns</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cms</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">use_pickle</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">pickle_name</span><span class="o">=</span><span class="s">&#39;default&#39;</span><span class="p">,</span>
                     <span class="n">line_profile</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">recreate</span><span class="o">=</span><span class="k">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;For fitting an external field in cartesian space.</span>

<span class="sd">        Note:</span>
<span class="sd">            Not currently used or maintained.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">a</span>     <span class="o">=</span> <span class="mi">3</span><span class="n">e4</span>
        <span class="n">b</span>     <span class="o">=</span> <span class="mi">3</span><span class="n">e4</span>
        <span class="n">c</span>     <span class="o">=</span> <span class="mi">3</span><span class="n">e4</span>

        <span class="n">Bz</span>    <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Bx</span>    <span class="o">=</span> <span class="p">[]</span>
        <span class="n">By</span>    <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Bzerr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Bxerr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Byerr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ZZ</span>    <span class="o">=</span> <span class="p">[]</span>
        <span class="n">XX</span>    <span class="o">=</span> <span class="p">[]</span>
        <span class="n">YY</span>    <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy_steps</span><span class="p">:</span>

            <span class="n">input_data_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">Y</span> <span class="o">==</span> <span class="n">y</span><span class="p">]</span>

            <span class="n">piv_bz</span> <span class="o">=</span> <span class="n">input_data_y</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s">&#39;Z&#39;</span><span class="p">,</span> <span class="s">&#39;X&#39;</span><span class="p">,</span> <span class="s">&#39;Bz&#39;</span><span class="p">)</span>
            <span class="n">piv_bx</span> <span class="o">=</span> <span class="n">input_data_y</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s">&#39;Z&#39;</span><span class="p">,</span> <span class="s">&#39;X&#39;</span><span class="p">,</span> <span class="s">&#39;Bx&#39;</span><span class="p">)</span>
            <span class="n">piv_by</span> <span class="o">=</span> <span class="n">input_data_y</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s">&#39;Z&#39;</span><span class="p">,</span> <span class="s">&#39;X&#39;</span><span class="p">,</span> <span class="s">&#39;By&#39;</span><span class="p">)</span>
            <span class="n">piv_bz_err</span> <span class="o">=</span> <span class="n">input_data_y</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s">&#39;Z&#39;</span><span class="p">,</span> <span class="s">&#39;X&#39;</span><span class="p">,</span> <span class="s">&#39;Bzerr&#39;</span><span class="p">)</span>
            <span class="n">piv_bx_err</span> <span class="o">=</span> <span class="n">input_data_y</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s">&#39;Z&#39;</span><span class="p">,</span> <span class="s">&#39;X&#39;</span><span class="p">,</span> <span class="s">&#39;Bxerr&#39;</span><span class="p">)</span>
            <span class="n">piv_by_err</span> <span class="o">=</span> <span class="n">input_data_y</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s">&#39;Z&#39;</span><span class="p">,</span> <span class="s">&#39;X&#39;</span><span class="p">,</span> <span class="s">&#39;Byerr&#39;</span><span class="p">)</span>

            <span class="n">X</span> <span class="o">=</span> <span class="n">piv_bx</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span>
            <span class="n">Z</span> <span class="o">=</span> <span class="n">piv_bx</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
            <span class="n">Bz</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">piv_bz</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">Bx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">piv_bx</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">By</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">piv_by</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">Bzerr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">piv_bz_err</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">Bxerr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">piv_bx_err</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">Byerr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">piv_by_err</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">XX_slice</span><span class="p">,</span> <span class="n">ZZ_slice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Z</span><span class="p">)</span>
            <span class="n">XX</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">XX_slice</span><span class="p">)</span>
            <span class="n">ZZ</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ZZ_slice</span><span class="p">)</span>
            <span class="n">YY_slice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">XX_slice</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">YY</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">YY_slice</span><span class="p">)</span>

        <span class="n">ZZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">ZZ</span><span class="p">)</span>
        <span class="n">XX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">XX</span><span class="p">)</span>
        <span class="n">YY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">YY</span><span class="p">)</span>
        <span class="n">Bz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">Bz</span><span class="p">)</span>
        <span class="n">Bx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">Bx</span><span class="p">)</span>
        <span class="n">By</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">By</span><span class="p">)</span>
        <span class="n">Bzerr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">Bzerr</span><span class="p">)</span>
        <span class="n">Bxerr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">Bxerr</span><span class="p">)</span>
        <span class="n">Byerr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">Byerr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">line_profile</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ZZ</span><span class="p">,</span> <span class="n">XX</span><span class="p">,</span> <span class="n">YY</span><span class="p">,</span> <span class="n">Bz</span><span class="p">,</span> <span class="n">Bx</span><span class="p">,</span> <span class="n">By</span>

        <span class="n">b_external_3d_fast</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">b_external_3d_producer</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">ZZ</span><span class="p">,</span> <span class="n">XX</span><span class="p">,</span> <span class="n">YY</span><span class="p">,</span> <span class="n">cns</span><span class="p">,</span> <span class="n">cms</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mod</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">b_external_3d_fast</span><span class="p">,</span> <span class="n">independent_vars</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;x&#39;</span><span class="p">,</span> <span class="s">&#39;y&#39;</span><span class="p">,</span> <span class="s">&#39;z&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">use_pickle</span> <span class="ow">or</span> <span class="n">recreate</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">pkl</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">pickle_name</span><span class="o">+</span><span class="s">&#39;_results.p&#39;</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">Parameters</span><span class="p">()</span>

        <span class="k">if</span> <span class="s">&#39;cns&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;cns&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">cns</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="k">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;cns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">cns</span>
        <span class="k">if</span> <span class="s">&#39;cms&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;cms&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">cms</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="k">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;cms&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">cms</span>

        <span class="k">if</span> <span class="s">&#39;epsilon1&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;epsilon1&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;epsilon1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vary</span> <span class="o">=</span> <span class="k">True</span>
        <span class="k">if</span> <span class="s">&#39;epsilon2&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;epsilon2&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;epsilon2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vary</span> <span class="o">=</span> <span class="k">True</span>

        <span class="k">for</span> <span class="n">cn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cns</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cms</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="s">&#39;C_{0}_{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cn</span><span class="p">,</span> <span class="n">cm</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;C_{0}_{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cn</span><span class="p">,</span> <span class="n">cm</span><span class="p">),</span> <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;C_{0}_{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cn</span><span class="p">,</span> <span class="n">cm</span><span class="p">)]</span><span class="o">.</span><span class="n">vary</span> <span class="o">=</span> <span class="k">True</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">recreate</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s">&#39;fitting external with cn={0}, cm={1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cns</span><span class="p">,</span> <span class="n">cms</span><span class="p">)</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">recreate</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">vary</span> <span class="o">=</span> <span class="k">False</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mod</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">Bx</span><span class="p">,</span> <span class="n">By</span><span class="p">,</span> <span class="n">Bz</span><span class="p">])</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">x</span><span class="o">=</span><span class="n">XX</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">YY</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">ZZ</span><span class="p">,</span>
                                       <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">&#39;leastsq&#39;</span><span class="p">,</span> <span class="n">fit_kws</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;maxfev&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="k">elif</span> <span class="n">use_pickle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mod</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">Bx</span><span class="p">,</span> <span class="n">By</span><span class="p">,</span> <span class="n">Bz</span><span class="p">])</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">x</span><span class="o">=</span><span class="n">XX</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">YY</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">ZZ</span><span class="p">,</span>
                                       <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">&#39;leastsq&#39;</span><span class="p">,</span>
                                       <span class="n">fit_kws</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;maxfev&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mod</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">Bx</span><span class="p">,</span> <span class="n">By</span><span class="p">,</span> <span class="n">Bz</span><span class="p">])</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">x</span><span class="o">=</span><span class="n">XX</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">YY</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">ZZ</span><span class="p">,</span>
                                       <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">&#39;leastsq&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">params</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">recreate</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s">&quot;Elapsed time was %g seconds&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>
            <span class="n">report_fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">,</span> <span class="n">show_correl</span><span class="o">=</span><span class="k">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_save</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">recreate</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pickle_results</span><span class="p">(</span><span class="n">pickle_name</span><span class="p">)</span></div>

<div class="viewcode-block" id="FieldFitter.pickle_results"><a class="viewcode-back" href="../../fitting.html#mu2e.fieldfitter.FieldFitter.pickle_results">[docs]</a>    <span class="k">def</span> <span class="nf">pickle_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pickle_name</span><span class="o">=</span><span class="s">&#39;default&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pickle the resulting Parameters after a fit is performed.&quot;&quot;&quot;</span>

        <span class="n">pkl</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">pickle_name</span><span class="o">+</span><span class="s">&#39;_results.p&#39;</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">),</span> <span class="n">pkl</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span></div>

<div class="viewcode-block" id="FieldFitter.merge_data_fit_res"><a class="viewcode-back" href="../../fitting.html#mu2e.fieldfitter.FieldFitter.merge_data_fit_res">[docs]</a>    <span class="k">def</span> <span class="nf">merge_data_fit_res</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Combine the fit results and the input data into one dataframe for easier</span>
<span class="sd">        comparison of results.</span>

<span class="sd">        Adds three columns to input_data: `Br_fit, Bphi_fit, Bz_fit`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">best_fit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">best_fit</span>

        <span class="n">df_fit</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">isc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">phi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phi_steps</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">phi</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">nphi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nphi</span> <span class="o">=</span> <span class="n">phi</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
            <span class="n">data_frame_phi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="p">[</span>
                <span class="p">(</span><span class="n">isc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">Phi</span><span class="p">,</span> <span class="n">phi</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">isc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">Phi</span><span class="p">,</span> <span class="n">nphi</span><span class="p">))</span>
            <span class="p">]</span>

            <span class="c"># careful sorting of values to match up with fit output bookkeeping</span>
            <span class="n">df_fit_tmp</span> <span class="o">=</span> <span class="n">data_frame_phi</span><span class="p">[</span>
                <span class="n">isc</span><span class="p">(</span><span class="n">data_frame_phi</span><span class="o">.</span><span class="n">Phi</span><span class="p">,</span> <span class="n">nphi</span><span class="p">)][[</span><span class="s">&#39;Z&#39;</span><span class="p">,</span> <span class="s">&#39;R&#39;</span><span class="p">,</span> <span class="s">&#39;Phi&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
                    <span class="p">[</span><span class="s">&#39;R&#39;</span><span class="p">,</span> <span class="s">&#39;Phi&#39;</span><span class="p">,</span> <span class="s">&#39;Z&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="k">False</span><span class="p">,</span> <span class="k">True</span><span class="p">,</span> <span class="k">True</span><span class="p">])</span>
            <span class="n">df_fit_tmp</span> <span class="o">=</span> <span class="n">df_fit_tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">data_frame_phi</span><span class="p">[</span><span class="n">isc</span><span class="p">(</span><span class="n">data_frame_phi</span><span class="o">.</span><span class="n">Phi</span><span class="p">,</span> <span class="n">phi</span><span class="p">)][[</span><span class="s">&#39;Z&#39;</span><span class="p">,</span> <span class="s">&#39;R&#39;</span><span class="p">,</span> <span class="s">&#39;Phi&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
                    <span class="p">[</span><span class="s">&#39;R&#39;</span><span class="p">,</span> <span class="s">&#39;Phi&#39;</span><span class="p">,</span> <span class="s">&#39;Z&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="k">True</span><span class="p">,</span> <span class="k">True</span><span class="p">,</span> <span class="k">True</span><span class="p">]))</span>

            <span class="n">l</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">best_fit</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">br</span> <span class="o">=</span> <span class="n">best_fit</span><span class="p">[:</span><span class="n">l</span><span class="p">]</span>
            <span class="n">bz</span> <span class="o">=</span> <span class="n">best_fit</span><span class="p">[</span><span class="n">l</span><span class="p">:</span><span class="nb">int</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">l</span><span class="p">)]</span>
            <span class="n">bphi</span> <span class="o">=</span> <span class="n">best_fit</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">l</span><span class="p">):]</span>
            <span class="n">p</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">br</span><span class="p">)</span>
            <span class="n">br</span> <span class="o">=</span> <span class="n">br</span><span class="p">[(</span><span class="n">i</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phi_steps</span><span class="p">))</span><span class="o">*</span><span class="n">p</span><span class="p">:((</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phi_steps</span><span class="p">))</span><span class="o">*</span><span class="n">p</span><span class="p">]</span>
            <span class="n">bz</span> <span class="o">=</span> <span class="n">bz</span><span class="p">[(</span><span class="n">i</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phi_steps</span><span class="p">))</span><span class="o">*</span><span class="n">p</span><span class="p">:((</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phi_steps</span><span class="p">))</span><span class="o">*</span><span class="n">p</span><span class="p">]</span>
            <span class="n">bphi</span> <span class="o">=</span> <span class="n">bphi</span><span class="p">[(</span><span class="n">i</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phi_steps</span><span class="p">))</span><span class="o">*</span><span class="n">p</span><span class="p">:((</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phi_steps</span><span class="p">))</span><span class="o">*</span><span class="n">p</span><span class="p">]</span>

            <span class="n">z_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_fit_tmp</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
            <span class="n">r_size</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">df_fit_tmp</span><span class="o">.</span><span class="n">R</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
            <span class="n">df_fit_tmp</span><span class="p">[</span><span class="s">&#39;Br_fit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">br</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">z_size</span><span class="p">,</span> <span class="n">r_size</span><span class="p">)))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">df_fit_tmp</span><span class="p">[</span><span class="s">&#39;Bz_fit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">bz</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">z_size</span><span class="p">,</span> <span class="n">r_size</span><span class="p">)))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">df_fit_tmp</span><span class="p">[</span><span class="s">&#39;Bphi_fit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">bphi</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">z_size</span><span class="p">,</span> <span class="n">r_size</span><span class="p">)))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

            <span class="n">df_fit</span> <span class="o">=</span> <span class="n">df_fit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_fit_tmp</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="p">,</span> <span class="n">df_fit</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;Z&#39;</span><span class="p">,</span> <span class="s">&#39;R&#39;</span><span class="p">,</span> <span class="s">&#39;Phi&#39;</span><span class="p">])</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Brian Pollack.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.0.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>